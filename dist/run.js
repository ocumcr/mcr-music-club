class n{static#t=!1;static audio=null;static#e;static#a;static#s;static load(t){return this.#a||(this.#a=new AudioContext,this.#s=this.#a.createGain(),this.#s.connect(this.#a.destination)),this.audio&&(this.audio.pause(),this.#e.disconnect()),this.audio=new Audio(t),this.#e=this.#a.createMediaElementSource(this.audio),this.#e.connect(this.#s),new Promise(e=>{this.audio.onloadedmetadata=a=>{this.#t=!0,e()}})}static play(){this.isReady()&&this.audio.play()}static pause(){this.isReady()&&this.audio.pause()}static isPlaying(){return this.isReady()&&!this.audio.paused}static setLoop(t){this.isReady()&&(this.audio.loop=t)}static isReady(){return this.#t}static setVolume(t){if(t<0||1<t){console.error("volume must range from 0 to 1.");return}this.#s.gain.value=t}static getDuration(){return this.isReady()?this.audio.duration:0}static set currentTime(t){this.isReady()&&(this.audio.currentTime=t)}static get currentTime(){return this.isReady()?this.audio.currentTime:0}}class l{static elements;static init(t,e,a){this.elements={playButton:document.getElementById("play-button"),seekBar:document.getElementById("seekBar"),currentTimeText:document.getElementById("currentTime"),durationText:document.getElementById("duration"),volumeControl:document.getElementById("volume"),musicTitle:document.getElementById("music-title"),miniThumbnail:document.getElementById("mini-thumbnail"),loopButton:document.getElementById("loop-button"),shuffleButton:document.getElementById("shuffle-button"),backButton:document.getElementById("back-button"),forwardButton:document.getElementById("forward-button")},this.#t(a),this.updateLoopButtonUI(t),this.updateShuffleButtonUI(e)}static#t(t){this.elements.volumeControl.value=""+t}static updateLoopButtonUI(t){const e=["loop-none","","loop-one"],a=["ループしない","ループする","一曲ループ"];this.elements.loopButton.dataset.loop=e[t],this.elements.loopButton.title=a[t]}static updateShuffleButtonUI(t){this.elements.shuffleButton.classList.toggle("shuffle-off",t===0)}static updatePlayButtonUI(t){this.elements.playButton.classList.toggle("button-playing",t)}static updateTrackInfo(t){this.elements.musicTitle.innerHTML=`${t.title}<br />${t.author}`,this.elements.miniThumbnail.style.backgroundImage=`url(${t.thumbnail})`,this.elements.miniThumbnail.style.backgroundSize="cover"}static updateSeekBarMaxAndDurationText(t){this.elements.durationText.innerText=this.#e(t),this.elements.seekBar.max=String(t)}static updateSeekBarAndCurrentTimeText(t){this.elements.currentTimeText.innerText=this.#e(t),this.elements.seekBar.value=String(t)}static#e(t){const e=Math.floor(t/60),a=Math.floor(t%60);return`${String(e).padStart(2,"0")}:${String(a).padStart(2,"0")}`}}class s{static debugLog;static content;static#t;static init(){this.debugLog=document.getElementById("debug-log"),this.content=document.querySelector(".content"),this.#t=document.getElementById("musics")}static displayDebugLog(){this.debugLog.style.display="block"}static addLog(t){console.log(t),this.debugLog.innerHTML+=t+"<br />"}static fadeIn(){this.content.classList.remove("fade-in"),requestAnimationFrame(()=>{this.content.classList.add("fade-in")})}static scrollTo(t){t<=0?window.scrollTo({top:0,behavior:"smooth"}):document.querySelectorAll(".track")[t-1].scrollIntoView({behavior:"smooth"})}static renderPlaylist(t,e){this.#t.innerHTML=t.map(this.#e).join(""),e&&this.setPlayCount(t,e)}static#e(t){const e=t.tags.map(a=>`<button class="tag-button">#${a}</button>`).join("");return`
            <li class="track" data-state="pause">
                <div class="img-box" style="
                    background: url(${t.thumbnail});
                    background-size: cover;
                ">
                    <i class="fa-solid fa-circle-play"></i>
                    <i class="fa-solid fa-circle-pause"></i>
                    <i class="fa-solid fa-spinner"></i>
                </div>
                <div class="description">
                    <h3>${t.title}</h3>
                    <p>${t.year}</p>
                    <p class="author">${t.author}</p>
                    <p>${t.description}</p>
                    <div class="tags">
                        ${e}
                    </div>
                </div>
                <div class="play-count">取得中...</div>
            </li>
        `}static setPlayCount(t,e){const a=document.querySelectorAll(".play-count");t.forEach((h,u)=>{const y=e[h.title]??0;a[u].innerText="再生回数: "+y})}static updatePlayingClass(t){this.#t.querySelectorAll(".track").forEach((e,a)=>{e.dataset.state=a===t?"playing":"pause"})}static setLoading(t){const e=this.#t.querySelectorAll(".track")[t];e&&(e.dataset.state="loading")}}class T{static setPositionState(t){"mediaSession"in navigator&&navigator.mediaSession.setPositionState({duration:t.duration,playbackRate:t.playbackRate,position:t.currentTime})}static setNavigationMenu(t){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.title??"",artist:t.author??"",artwork:[{src:t.thumbnail??""}]}))}}class r{static set volume(t){localStorage.setItem("volume",""+t)}static get volume(){return localStorage.volume?Number(localStorage.volume):50}static set loopMode(t){localStorage.setItem("loopMode",""+t)}static get loopMode(){return localStorage.loopMode?Number(localStorage.loopMode):0}static set shuffleMode(t){localStorage.setItem("shuffleMode",""+t)}static get shuffleMode(){return localStorage.shuffleMode?Number(localStorage.shuffleMode):0}}class g{static data=[];static playCountRecord=null}class P{static#t=!1;static init(){if(this.#t)throw new Error("すでにinitialized!");d.isDebugMode()&&(console.log("開けゴマ!"),s.displayDebugLog()),this.#t=!0}static setupTrackClickEvents(){const t=i.getPlaylist();document.querySelectorAll(".track").forEach((e,a)=>{e.querySelector(".img-box").onclick=()=>{i.getPlayingTrackIndex()===a?c.togglePlayback():c.changeTrack(t[a])},e.querySelector(".author").onclick=()=>{d.search(t[a].author)},e.querySelectorAll(".tag-button").forEach((h,u)=>{h.onclick=()=>{d.search(t[a].tags[u])}})})}}class i{static#t=[];static#e=[];static playingTrackTitle="";static getPlayingTrackIndex(){return this.#t.findIndex(t=>t.title===this.playingTrackTitle)}static hasPlayingTrack(){return this.getPlayingTrackIndex()!==-1}static setPlaylist(t,e){this.#e=t,this.#t=e?this.#a([...t]):t,this.#s()}static getPlaylist(){return this.#t}static setDefaultOrder(){this.#t=[...this.#e],this.#s()}static shufflePlaylist({moveCurrentTrackToTop:t}){if(this.hasPlayingTrack()){const e=this.#t[this.getPlayingTrackIndex()];do this.#t=this.#a([...this.#t]);while(t&&this.#t[0]!=e)}else this.#t=this.#a([...this.#t]);this.#s()}static getNextTrack(){if(!this.hasPlayingTrack())return{track:this.#t[0]};const t=(this.getPlayingTrackIndex()+1)%this.#t.length;return{track:this.#t[t]}}static getPreviousTrack(){if(!this.hasPlayingTrack())return{track:this.#t[0]};const t=(this.getPlayingTrackIndex()-1+this.#t.length)%this.#t.length;return{track:this.#t[t]}}static#a(t){return t.length==1?[...t]:[...t].reduce((e,a,h,u)=>{const y=Math.floor(Math.random()*(h+1));return[u[h],u[y]]=[u[y],a],u})}static#s(){s.renderPlaylist(this.#t,g.playCountRecord),P.setupTrackClickEvents(),n.isPlaying()&&s.updatePlayingClass(this.getPlayingTrackIndex())}}class m{static title;static searchBox;static searchForm;static init(){this.title=document.getElementById("title"),this.searchBox=document.getElementById("search-box"),this.searchForm=document.getElementById("search")}static setSearchBox(t){this.searchBox.value=t}}class d{static isDebugMode(){return new URL(window.location.href).searchParams.get("debug")==="true"}static search(t){t===""?this.#s():this.#a(t),this.handleQueryChange()}static handleQueryChange(){console.log("クエリパラメータが変更されました"),this.#t(),s.fadeIn()}static#t(){const t=this.#e();let e=g.data;t!==""&&(e=g.data.filter(a=>a.tags.includes(t)||a.title.includes(t)||a.author===t)),m.setSearchBox(t),i.setPlaylist(e,r.shuffleMode===1)}static#e(){return new URL(window.location.href).searchParams.get("search")??""}static#a(t){const e=new URL(window.location.href);e.searchParams.set("search",t),window.history.pushState({},"",e)}static#s(){const t=new URL(window.location.href);t.searchParams.delete("search"),window.history.pushState({},"",t)}}window.addEventListener("popstate",o=>{o.preventDefault(),d.handleQueryChange(),console.log("popped")});let f=!1;class p{static safeSendPlayCount(t){!f&&!d.isDebugMode()&&(this.#t(t),f=!0,setTimeout(()=>{f=!1},1e3))}static async fetchPlayCountRecord(){return await(await fetch("https://script.google.com/macros/s/AKfycbw-M6WdDND050H_DboJKixnDERBEYu1X24O6JthlZkohDJMKfrELuQ5YHDpbZ8N3eOh/exec")).json()}static async#t(t){try{const e=await fetch("https://script.google.com/macros/s/AKfycbya_x47m1TS70IhvejTmlMscmsGtheak2MvwYuXvVMse-Ar6UDv1EqmG_aQTSmDxRWc/exec",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t}),mode:"no-cors"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const a=await e.json();console.log(a.status==="success"?"送信完了！":"エラーが発生しました。")}catch(e){console.error("Error:",e),console.log("送信中にエラーが発生しました。")}}}class c{static#t=!1;static init(){if(this.#t)throw new Error("すでにinitialized!");this.#s(),this.#i(),this.#t=!0}static togglePlayback(){n.isReady()&&(n.isPlaying()?(n.pause(),l.updatePlayButtonUI(!1),s.updatePlayingClass(-1)):(n.play(),l.updatePlayButtonUI(!0),s.updatePlayingClass(i.getPlayingTrackIndex())))}static async handleBack(){if(n.currentTime>.5){n.currentTime=0;return}const{track:t}=i.getPreviousTrack();await this.changeTrack(t),s.scrollTo(i.getPlayingTrackIndex())}static async handleForward({scroll:t=!0}={}){const{track:e}=i.getNextTrack();await this.changeTrack(e),t&&s.scrollTo(i.getPlayingTrackIndex())}static async changeTrack(t){if(i.playingTrackTitle=t.title,!i.hasPlayingTrack())throw new Error("謎の方法でplaylistに存在しない曲を選択しようとしているにゃ！");const e=i.getPlayingTrackIndex();s.updatePlayingClass(e),s.setLoading(e),await n.load(t.path),n.setVolume(r.volume/100),n.setLoop(r.loopMode===2),n.play(),l.updateTrackInfo(t),l.updatePlayButtonUI(!0),l.updateSeekBarMaxAndDurationText(n.getDuration()),s.updatePlayingClass(e),T.setNavigationMenu(t),this.#e(n.audio),this.#a(n.audio),p.safeSendPlayCount(t.title)}static#e(t){t.ontimeupdate=()=>{if(l.updateSeekBarAndCurrentTimeText(t.currentTime),T.setPositionState(t),r.loopMode==2&&t.duration-t.currentTime<.65){const e=i.playingTrackTitle;e&&p.safeSendPlayCount(e)}}}static#a(t){t.onended=()=>{const e=i.getPlaylist().length-1===i.getPlayingTrackIndex();if(r.loopMode===1){if(e){i.shufflePlaylist({moveCurrentTrackToTop:!1}),this.changeTrack(i.getPlaylist()[0]),s.scrollTo(-1);return}this.handleForward({scroll:!1})}else if(r.loopMode===0){if(e){l.updatePlayButtonUI(!1),s.updatePlayingClass(-1);return}this.handleForward({scroll:!1})}}}static#s(){window.addEventListener("keydown",t=>{t.code==="Space"&&(t.preventDefault(),this.togglePlayback())})}static#i(){}}class v{static#t=!1;static init(){if(this.#t)throw new Error("すでにinitialized!");this.#e(),this.#a(),this.#t=!0}static#e(){m.searchForm.onsubmit=t=>{t.preventDefault(),d.search(m.searchBox.value)}}static#a(){m.title.onclick=t=>{t.preventDefault(),d.search("")}}}class b{static#t=!1;static init(){if(this.#t)throw new Error("すでにinitialized!");this.#a(),this.#s(),this.#i(),this.#o(),this.#n(),this.#e(),this.#t=!0}static#e(){l.elements.musicTitle.addEventListener("click",()=>{s.scrollTo(i.getPlayingTrackIndex())})}static#a(){l.elements.playButton.onclick=()=>c.togglePlayback(),l.elements.backButton.onclick=()=>c.handleBack(),l.elements.forwardButton.onclick=()=>c.handleForward()}static#s(){l.elements.seekBar.oninput=()=>{n.currentTime=+l.elements.seekBar.value}}static#i(){l.elements.volumeControl.oninput=t=>{r.volume=+t.target.value,n.setVolume(r.volume/100)}}static#o(){l.elements.loopButton.onclick=()=>{r.loopMode=(r.loopMode+1)%3,l.updateLoopButtonUI(r.loopMode),n.setLoop(r.loopMode===2)}}static#n(){l.elements.shuffleButton.onclick=()=>{r.shuffleMode=1-r.shuffleMode,r.shuffleMode===1?i.shufflePlaylist({moveCurrentTrackToTop:!0}):i.setDefaultOrder(),l.updateShuffleButtonUI(r.shuffleMode),s.scrollTo(i.getPlayingTrackIndex())}}}class S{static init(){"mediaSession"in navigator&&(this.#t("play",t=>{s.addLog(t.action),navigator.mediaSession.playbackState="playing",c.togglePlayback()}),this.#t("pause",t=>{s.addLog(t.action),navigator.mediaSession.playbackState="paused",c.togglePlayback()}),this.#t("nexttrack",t=>{s.addLog(t.action),c.handleForward()}),this.#t("previoustrack",t=>{s.addLog(t.action),c.handleBack()}),this.#t("seekto",t=>{s.addLog(t.action+": "+t.seekTime),n.currentTime=+t.seekTime}),this.#t("seekbackward",t=>{s.addLog(t.action+": "+t.seekOffset),n.currentTime-=+t.seekOffset}),this.#t("seekforward",t=>{s.addLog(t.action+": "+t.seekOffset),n.currentTime+=+t.seekOffset}))}static#t(t,e){navigator.mediaSession.setActionHandler(t,e)}}async function w(){l.init(r.loopMode,r.shuffleMode,r.volume),m.init(),s.init(),c.init(),v.init(),b.init(),P.init(),S.init();const o=await fetch("music-data.json");g.data=Object.freeze(await o.json()),d.handleQueryChange(),g.playCountRecord=Object.freeze(await p.fetchPlayCountRecord()),s.setPlayCount(i.getPlaylist(),g.playCountRecord)}function k(){try{w()}catch(o){alert(o)}}document.readyState==="complete"?k():document.addEventListener("DOMContentLoaded",k);
//# sourceMappingURL=run.js.map
