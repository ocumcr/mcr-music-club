var dt=Object.defineProperty;var J=a=>{throw TypeError(a)};var ht=(a,t,e)=>t in a?dt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var m=(a,t,e)=>ht(a,typeof t!="symbol"?t+"":t,e),q=(a,t,e)=>t.has(a)||J("Cannot "+e);var d=(a,t,e)=>(q(a,t,"read from private field"),e?e.call(a):t.get(a)),u=(a,t,e)=>t.has(a)?J("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(a):t.set(a,e),g=(a,t,e,i)=>(q(a,t,"write to private field"),i?i.call(a,e):t.set(a,e),e),r=(a,t,e)=>(q(a,t,"access private method"),e);var L,x,S,w;class l{static load(t,e){return d(this,S)||(g(this,S,new AudioContext),g(this,w,d(this,S).createGain()),d(this,w).connect(d(this,S).destination)),this.audio&&(this.audio.pause(),d(this,x).disconnect()),this.audio=new Audio(t),this.audio.loop=e,g(this,x,d(this,S).createMediaElementSource(this.audio)),d(this,x).connect(d(this,w)),new Promise(i=>{this.audio.onloadedmetadata=f=>{g(this,L,!0),i()}})}static play(){this.isReady()&&this.audio.play()}static pause(){this.isReady()&&this.audio.pause()}static isPlaying(){return this.isReady()&&!this.audio.paused}static setLoop(t){this.isReady()&&(this.audio.loop=t)}static isReady(){return d(this,L)}static setVolume(t){if(t<0||1<t){console.error("volume must range from 0 to 1.");return}d(this,w).gain.value=t}static getDuration(){return this.isReady()?this.audio.duration:0}static set currentTime(t){this.isReady()&&(this.audio.currentTime=t)}static get currentTime(){return this.isReady()?this.audio.currentTime:0}}L=new WeakMap,x=new WeakMap,S=new WeakMap,w=new WeakMap,u(l,L,!1),m(l,"audio",null),u(l,x),u(l,S),u(l,w);var M,O;class s{static isAvailable(){return this.currentTrackIndex!==-1}static setPlaylist(t,e){this.defaultOrderPlaylist=t,this.playlist=e?r(this,M,O).call(this,[...t]):t}static setDefaultOrder(){if(this.isAvailable()){const t=this.playlist[this.currentTrackIndex];this.currentTrackIndex=this.defaultOrderPlaylist.indexOf(t)}this.playlist=[...this.defaultOrderPlaylist]}static shufflePlaylist({moveCurrentTrackToTop:t}){if(this.isAvailable()){const e=this.playlist[this.currentTrackIndex];do this.playlist=r(this,M,O).call(this,[...this.playlist]);while(t&&this.playlist[0]!=e);t&&(this.currentTrackIndex=0)}else this.playlist=r(this,M,O).call(this,[...this.playlist])}static getCurrentTrackTitle(){return this.isAvailable()?this.playlist[this.currentTrackIndex].title:null}static getNextTrack(){if(!this.isAvailable())return{track:this.playlist[0],index:0};const t=(this.currentTrackIndex+1)%this.playlist.length;return{track:this.playlist[t],index:t}}static getPreviousTrack(){if(!this.isAvailable())return{track:this.playlist[0],index:0};const t=(this.currentTrackIndex-1+this.playlist.length)%this.playlist.length;return{track:this.playlist[t],index:t}}}M=new WeakSet,O=function(t){return t.length==1?[...t]:[...t].reduce((e,i,f,k)=>{const K=Math.floor(Math.random()*(f+1));return[k[f],k[K]]=[k[K],i],k})},u(s,M),m(s,"playlist",[]),m(s,"defaultOrderPlaylist",[]),m(s,"currentTrackIndex",-1);class y{}m(y,"data",[]),m(y,"playCountRecord");class n{static set volume(t){localStorage.setItem("volume",""+t)}static get volume(){return localStorage.volume?Number(localStorage.volume):50}static set loopMode(t){localStorage.setItem("loopMode",""+t)}static get loopMode(){return localStorage.loopMode?Number(localStorage.loopMode):0}static set shuffleMode(t){localStorage.setItem("shuffleMode",""+t)}static get shuffleMode(){return localStorage.shuffleMode?Number(localStorage.shuffleMode):0}}class B{static init(){this.title=document.getElementById("title"),this.search=document.getElementById("search")}static setSearchBox(t){this.search.value=t}}m(B,"title"),m(B,"search");var b,_,G,Y;class T{static isDebugMode(){return new URL(window.location.href).searchParams.get("debug")==="true"}static search(t){t===""?r(this,b,Y).call(this):r(this,b,G).call(this,t),this.handleQueryChange()}static handleQueryChange(){console.log("クエリパラメータが変更されました"),o.fadeIn();const t=s.getCurrentTrackTitle();B.setSearchBox("");const e=r(this,b,_).call(this);let i=y.data;e&&(i=y.data.filter(f=>f.tags.includes(e)||f.title.includes(e)||f.author===e),B.setSearchBox(e)),s.setPlaylist(i,n.shuffleMode===1),s.currentTrackIndex=s.playlist.findIndex(f=>f.title===t),o.renderPlaylist(s.playlist),l.isPlaying()&&o.updatePlayingClass(s.currentTrackIndex)}}b=new WeakSet,_=function(){return new URL(window.location.href).searchParams.get("search")||null},G=function(t){const e=new URL(window.location.href);e.searchParams.set("search",t),window.history.pushState({},"",e)},Y=function(){const t=new URL(window.location.href);t.searchParams.delete("search"),window.history.pushState({},"",t)},u(T,b);window.addEventListener("popstate",a=>{a.preventDefault(),T.handleQueryChange(),console.log("popped")});var E;class V{static init(){if(d(this,E))throw new Error("すでにinitialized!");g(this,E,!0)}static setupTrackClickEvents(t){document.querySelectorAll(".track").forEach((e,i)=>{e.querySelector(".img-box").onclick=()=>{s.currentTrackIndex===i?p.togglePlayback():p.changeTrack(t[i],i)},e.querySelector(".author").onclick=()=>{T.search(t[i].author)},e.querySelectorAll(".tag-button").forEach((f,k)=>{f.onclick=()=>{T.search(t[i].tags[k])}})})}}E=new WeakMap,u(V,E,!1);var P,$,W;class o{static init(){this.debugLog=document.getElementById("debug-log"),this.content=document.querySelector(".content"),g(this,P,document.querySelector(".musics"))}static addLog(t){console.log(t),this.debugLog.innerHTML+=t+"<br />"}static fadeIn(){this.content.classList.remove("fade-in"),requestAnimationFrame(()=>{this.content.classList.add("fade-in")})}static scrollTo(t){t<=0?window.scrollTo({top:0,behavior:"smooth"}):document.querySelectorAll(".track")[t-1].scrollIntoView({behavior:"smooth"})}static renderPlaylist(t){d(this,P).innerHTML=t.map(r(this,$,W)).join(""),V.setupTrackClickEvents(t),y.playCountRecord&&this.setPlayCount(t,y.playCountRecord)}static setPlayCount(t,e){const i=document.querySelectorAll(".play-count");t.forEach((f,k)=>{i[k].innerText="再生回数: "+(e[f.title]??0)})}static updatePlayingClass(t){d(this,P).querySelectorAll(".track").forEach((e,i)=>e.classList.toggle("playing",i===t))}}P=new WeakMap,$=new WeakSet,W=function(t){const e=t.tags.map(i=>`<button class="tag-button">#${i}</button>`).join("");return`
            <li class="track">
                <div class="img-box" style="
                    background: url(${t.thumbnail});
                    background-size: cover;
                ">
                    <i class="fa-solid fa-circle-play"></i>
                    <i class="fa-solid fa-circle-pause"></i>
                </div>
                <div class="description">
                    <h3>${t.title}</h3>
                    <p>${t.year}</p>
                    <p class="author">${t.author}</p>
                    <p>${t.description}</p>
                    <div class="tags">
                        ${e}
                    </div>
                </div>
                <div class="play-count">取得中...</div>
            </li>
        `},u(o,$),m(o,"debugLog"),m(o,"content"),u(o,P);class F{static setPositionState(t){navigator.mediaSession.setPositionState({duration:t.duration,playbackRate:t.playbackRate,position:t.currentTime})}static setNavigationMenu(t){"mediaSession"in navigator&&(navigator.mediaSession.metadata=new MediaMetadata({title:t.title??"",artist:t.author??"",artwork:[{src:t.thumbnail??""}]}))}static init(){"mediaSession"in navigator&&(navigator.mediaSession.setPositionState({}),navigator.mediaSession.setActionHandler("play",t=>{o.addLog(t.action),navigator.mediaSession.playbackState="playing",p.togglePlayback()}),navigator.mediaSession.setActionHandler("pause",t=>{o.addLog(t.action),navigator.mediaSession.playbackState="paused",p.togglePlayback()}),navigator.mediaSession.setActionHandler("nexttrack",t=>{o.addLog(t.action),p.handleForward()}),navigator.mediaSession.setActionHandler("previoustrack",t=>{o.addLog(t.action),p.handleBack()}),navigator.mediaSession.setActionHandler("seekto",t=>{o.addLog(t.action+": "+t.seekTime),l.currentTime=+t.seekTime}),navigator.mediaSession.setActionHandler("seekbackward",t=>{o.addLog(t.action+": "+t.seekOffset),l.currentTime-=+t.seekOffset}),navigator.mediaSession.setActionHandler("seekforward",t=>{o.addLog(t.action+": "+t.seekOffset),l.currentTime+=+t.seekOffset}))}}var I,X,j;class c{static init(t,e,i){this.elements={playButton:document.getElementById("play-button"),seekBar:document.getElementById("seekBar"),currentTimeText:document.getElementById("currentTime"),durationText:document.getElementById("duration"),volumeControl:document.getElementById("volume"),musicTitle:document.getElementById("music-title"),miniThumbnail:document.getElementById("mini-thumbnail"),loopButton:document.getElementById("loop-button"),shuffleButton:document.getElementById("shuffle-button"),backButton:document.getElementById("back-button"),forwardButton:document.getElementById("forward-button")},r(this,I,X).call(this,i),this.updateLoopButtonUI(t),this.updateShuffleButtonUI(e)}static updateLoopButtonUI(t){const e=["loop-none","","loop-one"],i=["ループしない","ループする","一曲ループ"];this.elements.loopButton.innerHTML=`
            <i class="fa-solid fa-repeat ${e[t]}"></i>
        `,this.elements.loopButton.title=i[t]}static updateShuffleButtonUI(t){this.elements.shuffleButton.innerHTML=`
            <i class="fa-solid fa-shuffle ${["shuffle-off",""][t]}"></i>
        `}static updatePlayButtonUI(t){this.elements.playButton.innerHTML=`
            <i class="fa-solid fa-${t?"pause":"play"}"></i>
        `}static updateTrackInfo(t){this.elements.musicTitle.innerHTML=`${t.title}<br />${t.author}`,this.elements.miniThumbnail.style.backgroundImage=`url(${t.thumbnail})`,this.elements.miniThumbnail.style.backgroundSize="cover"}static updateDurationText(t){this.elements.durationText.innerText=r(this,I,j).call(this,t)}static updateSeekBarMax(t){this.elements.seekBar.max=String(t)}static updateSeekBarAndCurrentTimeText(t){this.elements.currentTimeText.innerText=r(this,I,j).call(this,t),this.elements.seekBar.value=String(t)}}I=new WeakSet,X=function(t){this.elements.volumeControl.value=""+t},j=function(t){const e=Math.floor(t/60),i=Math.floor(t%60);return`${String(e).padStart(2,"0")}:${String(i).padStart(2,"0")}`},u(c,I),m(c,"elements");let N=!1;var z,Z;class H{static safeSendPlayCount(t){!N&&!T.isDebugMode()&&(r(this,z,Z).call(this,t),N=!0,setTimeout(()=>{N=!1},1e3))}static async fetchPlayCountData(){return await(await fetch("https://script.google.com/macros/s/AKfycbw-M6WdDND050H_DboJKixnDERBEYu1X24O6JthlZkohDJMKfrELuQ5YHDpbZ8N3eOh/exec")).json()}}z=new WeakSet,Z=async function(t){try{const e=await fetch("https://script.google.com/macros/s/AKfycbya_x47m1TS70IhvejTmlMscmsGtheak2MvwYuXvVMse-Ar6UDv1EqmG_aQTSmDxRWc/exec",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t}),mode:"no-cors"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const i=await e.json();console.log(i.status==="success"?"送信完了！":"エラーが発生しました。")}catch(e){console.error("Error:",e),console.log("送信中にエラーが発生しました。")}},u(H,z);var A,h,tt,et,at,it,st,ot;class U{static init(){if(d(this,A))throw new Error("すでにinitialized!");r(this,h,et).call(this),r(this,h,at).call(this),r(this,h,it).call(this),r(this,h,st).call(this),r(this,h,ot).call(this),r(this,h,tt).call(this),g(this,A,!0)}static setupSeekBarUpdate(t){t.ontimeupdate=()=>{if(c.updateSeekBarAndCurrentTimeText(t.currentTime),F.setPositionState(t),n.loopMode==2&&t.duration-t.currentTime<.65){const e=s.getCurrentTrackTitle();e&&H.safeSendPlayCount(e)}}}}A=new WeakMap,h=new WeakSet,tt=function(){c.elements.musicTitle.addEventListener("click",()=>{o.scrollTo(s.currentTrackIndex)})},et=function(){c.elements.playButton.onclick=()=>p.togglePlayback(),c.elements.backButton.onclick=()=>p.handleBack(),c.elements.forwardButton.onclick=()=>p.handleForward()},at=function(){c.elements.seekBar.oninput=()=>{l.currentTime=+c.elements.seekBar.value}},it=function(){c.elements.volumeControl.oninput=t=>{n.volume=+t.target.value,l.setVolume(n.volume/100)}},st=function(){c.elements.loopButton.onclick=()=>{n.loopMode=(n.loopMode+1)%3,n.loopMode=n.loopMode,c.updateLoopButtonUI(n.loopMode),l.setLoop(n.loopMode===2)}},ot=function(){c.elements.shuffleButton.onclick=()=>{n.shuffleMode=1-n.shuffleMode,n.shuffleMode=n.shuffleMode,c.updateShuffleButtonUI(n.shuffleMode),n.shuffleMode===1?s.shufflePlaylist({moveCurrentTrackToTop:!0}):s.setDefaultOrder(),o.renderPlaylist(s.playlist),o.updatePlayingClass(s.currentTrackIndex),o.scrollTo(s.currentTrackIndex)}},u(U,h),u(U,A,!1);var D,v,nt,lt,rt;class p{static init(){if(d(this,D))throw new Error("すでにinitialized!");r(this,v,lt).call(this),r(this,v,rt).call(this),g(this,D,!0)}static togglePlayback(){l.isReady()&&(l.isPlaying()?(l.pause(),c.updatePlayButtonUI(!1),o.updatePlayingClass(-1)):(l.play(),c.updatePlayButtonUI(!0),o.updatePlayingClass(s.currentTrackIndex)))}static async handleBack(){if(l.currentTime>.5){l.currentTime=0;return}const{track:t,index:e}=s.getPreviousTrack();await this.changeTrack(t,e),o.scrollTo(s.currentTrackIndex)}static async handleForward({scroll:t=!0}={}){const{track:e,index:i}=s.getNextTrack();await this.changeTrack(e,i),t&&o.scrollTo(s.currentTrackIndex)}static async changeTrack(t,e){await l.load(t.path,n.loopMode===2),l.setVolume(n.volume/100),l.play(),U.setupSeekBarUpdate(l.audio),r(this,v,nt).call(this,l.audio);const i=l.getDuration();c.updateTrackInfo(t),c.updatePlayButtonUI(!0),c.updateSeekBarMax(i),c.updateDurationText(i),o.updatePlayingClass(e),F.setNavigationMenu(t),s.currentTrackIndex=e,H.safeSendPlayCount(t.title)}}D=new WeakMap,v=new WeakSet,nt=function(t){t.onended=()=>{if(n.loopMode===1)this.handleForward({scroll:!1});else if(n.loopMode===0){if(s.playlist.length-1===s.currentTrackIndex){c.updatePlayButtonUI(!1),o.updatePlayingClass(-1);return}this.handleForward({scroll:!1})}}},lt=function(){window.addEventListener("keydown",t=>{t.code==="Space"&&(t.preventDefault(),this.togglePlayback())})},rt=function(){},u(p,v),u(p,D,!1);var R,C,ct,ut;class Q{static init(){if(d(this,R))throw new Error("すでにinitialized!");r(this,C,ct).call(this),r(this,C,ut).call(this),g(this,R,!0)}}R=new WeakMap,C=new WeakSet,ct=function(){const t=document.querySelector(".search");t.onsubmit=e=>{e.preventDefault(),T.search(B.search.value)}},ut=function(){B.title.onclick=t=>{t.preventDefault(),T.search("")}},u(Q,C),u(Q,R,!1);window.addEventListener("DOMContentLoaded",ft);async function ft(){c.init(n.loopMode,n.shuffleMode,n.volume),B.init(),o.init(),p.init(),Q.init(),U.init(),V.init(),F.init();const a=await fetch("music-data.json");y.data=Object.freeze(await a.json()),s.setPlaylist(y.data,n.shuffleMode===1),T.handleQueryChange(),T.isDebugMode()&&(console.log("開けゴマ!"),o.debugLog.style.display="block"),y.playCountRecord=Object.freeze(await H.fetchPlayCountData()),o.setPlayCount(s.playlist,y.playCountRecord)}
